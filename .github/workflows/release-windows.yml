name: Release Windows Build

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read app version
        id: meta
        shell: bash
        run: |
          VERSION=$(python - <<'PY'
          import pathlib
          import re

          text = pathlib.Path("src/erpermitsys/version.py").read_text(encoding="utf-8")
          match = re.search(r'^APP_VERSION\s*=\s*"([^"]+)"', text, re.MULTILINE)
          if not match:
              raise SystemExit("APP_VERSION was not found in src/erpermitsys/version.py")
          print(match.group(1))
          PY
          )
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "APP_VERSION must be x.y.z, got: '$VERSION'"
            exit 1
          fi
          TAG="v$VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Preparing release $TAG from commit $GITHUB_SHA"

      - name: Ensure release tag does not already exist
        shell: bash
        run: |
          TAG="${{ steps.meta.outputs.tag }}"
          if git ls-remote --tags origin "refs/tags/$TAG" | grep -q "refs/tags/$TAG"; then
            echo "Tag $TAG already exists on origin. Bump APP_VERSION before releasing."
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build app (PyInstaller onedir)
        shell: bash
        run: |
          pyinstaller --noconfirm --clean --windowed \
            --noupx \
            --name erpermitsys \
            --paths src \
            --add-data "src/erpermitsys/ui/theme;erpermitsys/ui/theme" \
            --add-data "assets;assets" \
            --add-data "plugins;plugins" \
            --add-data "config;config" \
            run.py

      - name: Import code-signing certificate (optional)
        if: ${{ secrets.WINDOWS_SIGNING_CERT_PFX_BASE64 != '' && secrets.WINDOWS_SIGNING_CERT_PASSWORD != '' }}
        shell: pwsh
        run: |
          $certPath = Join-Path $env:RUNNER_TEMP "codesign.pfx"
          [IO.File]::WriteAllBytes(
            $certPath,
            [Convert]::FromBase64String("${{ secrets.WINDOWS_SIGNING_CERT_PFX_BASE64 }}")
          )
          "WINDOWS_SIGNING_CERT_PATH=$certPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Sign Windows executable (optional)
        if: ${{ env.WINDOWS_SIGNING_CERT_PATH != '' }}
        shell: pwsh
        run: |
          signtool sign /fd SHA256 `
            /f "$env:WINDOWS_SIGNING_CERT_PATH" `
            /p "${{ secrets.WINDOWS_SIGNING_CERT_PASSWORD }}" `
            /tr "http://timestamp.digicert.com" `
            /td SHA256 `
            "dist/erpermitsys/erpermitsys.exe"

      - name: Package zip asset
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/erpermitsys/*" -DestinationPath "dist/erpermitsys-windows.zip" -Force

      - name: Publish GitHub release asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.tag }}
          target_commitish: ${{ github.sha }}
          files: dist/erpermitsys-windows.zip
          generate_release_notes: true
